# Copilot Instructions for VovkPLCRuntime

## Build Rules
- **Always run `npm run build`** after modifying any C++ source files in `src/` or `wasm/VovkPLC.cpp` - this compiles the WASM module
- The WASM build requires LLVM (clang++ and wasm-ld) to be installed
- Build output goes to `wasm/dist/` - only `VovkPLC.wasm` is generated
- **`VovkPLC.js` and `VovkPLC.worker.js` are hand-written** - they are NOT generated by the build and should be edited directly when needed
- Do NOT delete `VovkPLC.js` or `VovkPLC.worker.js` thinking they will be regenerated

## Testing
- Run `npm run test` to execute all tests (unit tests)
- Individual test scripts are in `wasm/node-test/`:
  - `npm run test_ladder` - Ladder to STL compiler unit tests
  - `npm run test_project` - Full PLC project compilation unit test
- Run tests after any significant C++ changes to verify functionality
- The runtime has built-in unit tests that can be enabled with `#define __RUNTIME_FULL_UNIT_TEST___`

## Project Context
- This is a PLC (Programmable Logic Controller) runtime library - a stack-based virtual machine
- Runs on: Arduino/embedded devices (C++), browsers (WASM), desktop (Node.js)
- The runtime executes custom PLC bytecode compiled from PLCASM assembly
- Memory model: immutable program memory + mutable data memory
- This library is used as a dependency by VovkPLCEditor

### Compilation Pipeline (handled by this runtime)
- **PLCASM** → Bytecode (via internal compiler)
- **STL** → PLCASM → Bytecode (via STL compiler in `src/tools/assembly/`)
- **Ladder JSON** → Network IR → STL → PLCASM → Bytecode (via ladder compiler)
- Key compiler files:
  - `src/tools/assembly/plcasm-compiler.h` - PLCASM assembler
  - `src/tools/assembly/plcasm-linter.h` - PLCASM linter
  - `src/tools/assembly/ladder-compiler.h` - Ladder/STL/Network IR compilers
  - `src/tools/assembly/network-ir.h` - Network IR data structures

## Code Structure
- `src/VovkPLCRuntime.h` - Main include file
- `src/tools/` - Core runtime implementation:
  - `runtime-instructions.h` / `runtime-instructions-impl.h` - VM instruction set
  - `runtime-program.h` - Program memory management
  - `runtime-test.h` / `runtime-test-impl.h` - Built-in unit tests
  - `arithmetics/` - Math operations, CRC, bitwise ops
  - `assembly/` - Compilers (PLCASM, STL, Ladder, Network IR)
  - `stack/` - Stack implementation
- `wasm/VovkPLC.cpp` - WASM entry point and exported functions
- `wasm/node-test/` - Node.js test scripts
- `examples/` - Arduino example sketches

## Platform Targets
### Arduino/Embedded (C++)
- Compatible with most Arduino boards (AVR, STM32, ESP32, etc.)
- PlatformIO example in `examples/platformio_example/`

### WASM/Browser/Node.js
- Compiled with `__WASM__` define
- Uses `WASM_EXPORT` macro for exported functions
- Memory management via custom allocators in `src/tools/assembly/wasm/`

### JavaScript Wrapper Files (`wasm/dist/`)
These files are **manually authored** (NOT generated) and interface with the bare-metal WASM output:

#### `VovkPLC.js` - Main JavaScript API
- **DO NOT DELETE OR RENAME** - This is a hand-written wrapper, not build output
- Provides the `VovkPLC` class for direct WASM interaction (synchronous, main thread)
- Provides `VovkPLC.createWorker()` factory for worker-based usage (async, non-blocking)
- Handles WASM loading, memory management, and JS ↔ WASM communication
- Works in both browser and Node.js environments (`isNodeRuntime` detection)
- SharedArrayBuffer support for zero-copy memory sharing with workers

#### `VovkPLC.worker.js` - Web Worker Entry Point
- **DO NOT DELETE OR RENAME** - This is a hand-written worker script
- Runs VovkPLC instances in a separate thread (browser Web Worker or Node.js worker_threads)
- Message-based communication with main thread
- Supports multiple PLC instances per worker (`instances` Map)
- Features:
  - Request batching via ArrayBuffer for high-throughput operations
  - SharedArrayBuffer ring buffer for lock-free communication (64MB shared memory)
  - `enqueue()` function serializes operations per instance
- Control flags: `queueLoopActive`, `sharedLoopActive`

## Code Style
- C++11 standard (`-std=c++11`)
- Use `#pragma once` for header guards
- Use fixed-width types: `u8`, `u16`, `u32`, `i8`, `i16`, `i32`, `f32`, `f64`
- Prefix WASM-exported functions with `WASM_EXPORT`
- Use `const` for immutable data
- Keep embedded-compatible (no STL, minimal dynamic allocation)
- Use static buffers where possible for embedded compatibility
- GPL-3.0-or-later license headers on all source files

## Important Notes
- This is a header-only library for Arduino compatibility
- The `library.properties` file defines Arduino Library Manager metadata
- WASM build uses `clang++` with `--target=wasm32-undefined-undefined-wasm`
- No external dependencies for core runtime (Arduino-compatible)
- Node.js tests use ES modules (`"type": "module"` in package.json)
- Do not trust changes made to the compiler, test sample code by echoing as a single quote escaped string and piping it to `npm run explain` which will explain and analyze the final bytecode step by step with the stack state after each instruction and the program pointer we are at.